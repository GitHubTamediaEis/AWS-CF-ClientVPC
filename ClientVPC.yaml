AWSTemplateFormatVersion: "2010-09-09"
Description: Setup a VPC with private, public and IntraVpc subnets in three AZs. Includes one NAT- and one Internet-Gateway. Optional Transit Gateway attachement and custom features.

Parameters:

  VpcSize:
    Type: String
    Default: "S"
    Description: Select the size of your VPC.
    AllowedValues: 
      - "S"
      - "M"
      - "L"
      - "XL"
     
  ValidationToken:
    Type: String
    Description: "If you select a VPC size other than S, you need to request a token from Network Services first (network@tamedia.ch) providing the following details: Requirement for bigger VPC, the region to deploy in, your account ID and the desired VPC size."

  ConnectToCentralRouter:
    Type: String
    Default: "yes"
    Description: "Do you need access to other accounts, Corp shared services or VPN connections? (YES/no)"
    AllowedValues: 
      - "yes"
      - "no"
    ConstraintDescription: Value must be either "yes" or "no".

  UseMediaItDomainServices:
    Type: String
    Default: "no"
    Description: Do you need access to mediait.ch domain services (NO/yes) 
    AllowedValues: 
      - "yes"
      - "no"
    ConstraintDescription: Value must be either "yes" or "no".

  CustomImplementationTag:
    Type: String
    Default: ""
    Description: "Custom ID provided by Tamedia IT for specific implementation, if any"

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label: { default: Vpc size }
        Parameters:
          - VpcSize
          - ValidationToken
      - Label: { default: Central Services }
        Parameters:
          - ConnectToCentralRouter
          - UseMediaItDomainServices
      - Label: { default: Customized implementations }
        Parameters:
          - CustomImplementationTag

    ParameterLabels:
      VpcSize:
        default: Size of the VPC
      ValidationToken:
        default: Token for M, L and XL sized VPC
      ConnectToCentralRouter:
        default: Connect to central router (Transit Gateway)
      UseMediaItDomainServices:
        default: Access to MediaIT services 
      CustomImplementationTag:
        default: Customized implemetation Tag

Conditions:
  CreateTGWAttachement: !Equals [ !Ref ConnectToCentralRouter, "yes" ]
  CreateIntraVpc: !Not [ !Equals [ !Ref VpcSize, "S" ] ]
  AssociateMediaItDnsResolver: !Equals [ !Ref UseMediaItDomainServices, "yes" ]

Mappings: 
  RegionMap: 
    eu-west-1: 
      "TransitGatewayId": "tgw-009829a53d1bc69b8"
      "Az1": "eu-west-1a"
      "Az2": "eu-west-1b"
      "Az3": "eu-west-1c"
      "ClientAttachmentSNSARN": "arn:aws:sns:eu-west-1:733626620836:ClientAttachmentCustomResource"
      "MediaItResolverRuleId": "rslvr-rr-19d7f32e7a0a41959"

    eu-central-1: 
      "TransitGatewayId": "tgw-09b008f794dcaf554"
      "Az1": "eu-central-1a"
      "Az2": "eu-central-1b"
      "Az3": "eu-central-1c"
      "ClientAttachmentSNSARN": "arn:aws:sns:eu-central-1:733626620836:ClientAttachmentCustomResource"
      "MediaItResolverRuleId": "Sorry, mediait.ch resolution is currently not available in region eu-central-1."


Resources:

# Create the VPCIpAddresses

  VpcIpAddressesCustomResource:
    Type: Custom::VpcIpAddresses
    Properties: 
      ServiceToken: !Sub arn:aws:sns:${AWS::Region}:733626620836:VpcIpAddressesCustomResource
      VpcSize: !Ref VpcSize
      Token: !Ref ValidationToken

# Setup the main Vpc component

  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      EnableDnsSupport: true
      EnableDnsHostnames: true
      CidrBlock: !GetAtt VpcIpAddressesCustomResource.outputVpcCidrBlock
      Tags:
      - Key: Name
        Value: SC-VPC

# Setup the primary public subnet

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !FindInMap [RegionMap, !Ref "AWS::Region", Az1]
      VpcId: !Ref Vpc
      CidrBlock: !GetAtt VpcIpAddressesCustomResource.outputAz1Public
      Tags:
        - Key: Name
          Value: SC-VPC-PublicSubnet1

# Setup the secondary public subnet

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !FindInMap [RegionMap, !Ref "AWS::Region", Az2]
      VpcId: !Ref Vpc
      CidrBlock: !GetAtt VpcIpAddressesCustomResource.outputAz2Public
      Tags:
        - Key: Name
          Value: SC-VPC-PublicSubnet2

# Setup the third public subnet

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !FindInMap [RegionMap, !Ref "AWS::Region", Az3]
      VpcId: !Ref Vpc
      CidrBlock: !GetAtt VpcIpAddressesCustomResource.outputAz3Public
      Tags:
        - Key: Name
          Value: SC-VPC-PublicSubnet3

# Setup the primary private subnet

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !FindInMap [RegionMap, !Ref "AWS::Region", Az1]
      VpcId: !Ref Vpc
      CidrBlock: !GetAtt VpcIpAddressesCustomResource.outputAz1Private
      Tags:
        - Key: Name
          Value: SC-VPC-PrivateSubnet1

# Setup the secondary private subnet

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !FindInMap [RegionMap, !Ref "AWS::Region", Az2]
      VpcId: !Ref Vpc
      CidrBlock: !GetAtt VpcIpAddressesCustomResource.outputAz2Private
      Tags:
        - Key: Name
          Value: SC-VPC-PrivateSubnet2

# Setup the third private subnet

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !FindInMap [RegionMap, !Ref "AWS::Region", Az3]
      VpcId: !Ref Vpc
      CidrBlock: !GetAtt VpcIpAddressesCustomResource.outputAz3Private
      Tags:
        - Key: Name
          Value: SC-VPC-PrivateSubnet3

# Setup the primary private subnet

  IntraVpcSubnet1:
    Type: AWS::EC2::Subnet
    Condition: CreateIntraVpc
    Properties:
      AvailabilityZone: !FindInMap [RegionMap, !Ref "AWS::Region", Az1]
      VpcId: !Ref Vpc
      CidrBlock: !GetAtt VpcIpAddressesCustomResource.outputAz1IntraVpc
      Tags:
        - Key: Name
          Value: SC-VPC-IntraVpcSubnet1

# Setup the secondary private subnet

  IntraVpcSubnet2:
    Type: AWS::EC2::Subnet
    Condition: CreateIntraVpc
    Properties:
      AvailabilityZone: !FindInMap [RegionMap, !Ref "AWS::Region", Az2]
      VpcId: !Ref Vpc
      CidrBlock: !GetAtt VpcIpAddressesCustomResource.outputAz2IntraVpc
      Tags:
        - Key: Name
          Value: SC-VPC-IntraVpcSubnet2

# Setup the third private subnet

  IntraVpcSubnet3:
    Type: AWS::EC2::Subnet
    Condition: CreateIntraVpc
    Properties:
      AvailabilityZone: !FindInMap [RegionMap, !Ref "AWS::Region", Az3]
      VpcId: !Ref Vpc
      CidrBlock: !GetAtt VpcIpAddressesCustomResource.outputAz3IntraVpc
      Tags:
        - Key: Name
          Value: SC-VPC-IntraVpcSubnet3

# Setup the internet gateway

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
     Tags:
       - Key: Name
         Value: SC-VPC-InternetGateway

# Attach the internet gateway to the Vpc

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref Vpc
      InternetGatewayId: !Ref InternetGateway
  
# Attach VPC to the global tamedia corp transit gateway

  AttachmentToTransitGateway:
    Condition: CreateTGWAttachement
    Type: AWS::EC2::TransitGatewayAttachment
    Properties: 
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      Tags:
        - Key: Name
          Value: !Sub ${AWS::AccountId}-AttachToTransitGateway
      TransitGatewayId: !FindInMap [RegionMap, !Ref "AWS::Region", TransitGatewayId]
      VpcId: !Ref Vpc
  
# Call lambda for the required additionnal actions on the TGW attachment

  TGWattachementCustomResource:
    Type: Custom::NewTGWAttachement
    Condition: CreateTGWAttachement
#    DependsOn: NatGateway
#    DependsOn: AttachmentToTransitGateway
    Properties: 
      ServiceToken: !FindInMap [RegionMap, !Ref "AWS::Region", ClientAttachmentSNSARN]
      # Region: !Ref "AWS::Region"
      TransitGatewayAttachmentId: !Ref AttachmentToTransitGateway
      CustomImplementationTag: !Ref CustomImplementationTag
      VpcCidrBlock: !GetAtt VpcIpAddressesCustomResource.outputVpcCidrBlock

  # VpnGateway:
  #   Type: AWS::EC2::VPNGateway
  #   Condition: CreateVpn
  #   Properties:
  #     Type: ipsec.1
  #     Tags:
  #       - Key: Name
  #         Value: SC-VPC-VpnGateway

  # CustomerVpnGateway:  
  #   Type: "AWS::EC2::CustomerGateway"
  #   Condition: CreateCustomerGateway
  #   Properties:
  #     BgpAsn: 65000
  #     IpAddress: !Ref CustomerGatewayAddress
  #     Type: ipsec.1
  #     Tags:
  #       - Key: Name
  #         Value: SC-VPC-CustomerGateway

  # VpnConnection:
  #   Type: AWS::EC2::VPNConnection
  #   Condition: CreateVpn
  #   Properties:
  #     Type: ipsec.1
  #     StaticRoutesOnly: true
  #     VpnGatewayId: !Ref VpnGateway
  #     CustomerGatewayId: !If [CreateCustomerGateway, !Ref CustomerVpnGateway, !Ref CustomerGatewayId]
  #     Tags:
  #       - Key: Name
  #         Value: SC-VPC-VpnConnection

  # VpnConnectionRoute:
  #   Type: AWS::EC2::VPNConnectionRoute
  #   Condition: CreateVpn
  #   Properties:
  #     VpnConnectionId: !Ref VpnConnection
  #     DestinationCidrBlock: 145.234.0.0/16

  # VpnConnectionRoute2:
  #   Type: AWS::EC2::VPNConnectionRoute
  #   Condition: CreateVpn
  #   Properties:
  #     VpnConnectionId: !Ref VpnConnection
  #     DestinationCidrBlock: 10.30.0.0/16

  # VpnConnectionRoute3:
  #   Type: AWS::EC2::VPNConnectionRoute
  #   Condition: CreateVpn
  #   Properties:
  #     VpnConnectionId: !Ref VpnConnection
  #     DestinationCidrBlock: 10.24.0.0/16     

  # VpnConnectionRoute4:
  #     Type: AWS::EC2::VPNConnectionRoute
  #     Condition: CreateVpn
  #     Properties:
  #       VpnConnectionId: !Ref VpnConnection
  #       DestinationCidrBlock: 10.0.240.0/23  

  # VpnConnectionRoute5:
  #     Type: AWS::EC2::VPNConnectionRoute
  #     Condition: CreateVpn
  #     Properties:
  #       VpnConnectionId: !Ref VpnConnection
  #       DestinationCidrBlock: 10.0.249.0/24

  # VpnConnectionRoute6:
  #     Type: AWS::EC2::VPNConnectionRoute
  #     Condition: CreateVpn
  #     Properties:
  #       VpnConnectionId: !Ref VpnConnection
  #       DestinationCidrBlock: 10.0.250.0/24      

  # VpnConnectionRoute7:
  #     Type: AWS::EC2::VPNConnectionRoute
  #     Condition: CreateVpn
  #     Properties:
  #       VpnConnectionId: !Ref VpnConnection
  #       DestinationCidrBlock: 10.100.4.0/22      

  # AttachVpnGateway:
  #   Type: AWS::EC2::VPCGatewayAttachment
  #   Condition: CreateVpn
  #   Properties:
  #     VpcId: !Ref Vpc
  #     VpnGatewayId: !Ref VpnGateway

  NatGatewayEip:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEip.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: SC-VPC-NatGateway

  # DhcpOptions:
  #   Type: AWS::EC2::DHCPOptions
  #   Condition: DefineCustomDNSParameters
  #   Properties:
  #     DomainName: !Ref DnsDomainName
  #     DomainNameServers: !Ref DnsServers
  #     NtpServers: !Ref NtpServers
  #     Tags:
  #       - Key: Name
  #         Value: SC-VPC-DhcpOptions

  # AttachDhcpOptions:
  #   Type: AWS::EC2::VPCDHCPOptionsAssociation
  #   Condition: DefineCustomDNSParameters
  #   Properties: 
  #     DhcpOptionsId: !Ref DhcpOptions
  #     VpcId: !Ref Vpc

  # VpcPeering:
  #   Type: "AWS::EC2::VPCPeeringConnection"
  #   Condition: CreateVpcPeering
  #   Properties: 
  #     PeerVpcId: !Ref PeerVpc
  #     VpcId: !Ref Vpc
  #     Tags:
  #       - Key: Name
  #         Value: SC-VPC-MgmtVpcPeering

# Setup a public route table

  RouteTablePublic:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: SC-VPC-Public

# Setup the primary private route table

  RouteTablePrivate:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: SC-VPC-Private

# Setup the primary intra VPC route table

  RouteTableIntraVpc:
    Type: AWS::EC2::RouteTable
    Condition: CreateIntraVpc
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: SC-VPC-IntraVpc

# Add routes for public subnets

  # PeeringRoutePublic:
  #   Type: AWS::EC2::Route
  #   Condition: CreateVpcPeering
  #   Properties:
  #     RouteTableId: !Ref RouteTablePublic
  #     DestinationCidrBlock: !Ref PeerVpcCidr
  #     VpcPeeringConnectionId: !Ref VpcPeering      

  # PeeringRoutePublicPeerVpc:
  #   Type: AWS::EC2::Route
  #   Condition: CreateVpcPeering
  #   Properties:
  #     RouteTableId: !Ref PeerVpcPublicRouteTable
  #     DestinationCidrBlock:
  #       !GetAtt VpcIpAddressesCustomResource.outputVpcCidrBlock
  #     VpcPeeringConnectionId: !Ref VpcPeering

  InternetRoutePublic:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref RouteTablePublic
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  RoutePublicTGW1:
    Type: AWS::EC2::Route
    Condition: CreateTGWAttachement
    DependsOn: AttachmentToTransitGateway
    Properties:
      RouteTableId: !Ref RouteTablePublic
      DestinationCidrBlock: 145.234.0.0/16
      TransitGatewayId: !FindInMap [RegionMap, !Ref "AWS::Region", TransitGatewayId]

  RoutePublicTGW2:
    Type: AWS::EC2::Route
    Condition: CreateTGWAttachement
    DependsOn: AttachmentToTransitGateway
    Properties:
      RouteTableId: !Ref RouteTablePublic
      DestinationCidrBlock: 10.0.0.0/8
      TransitGatewayId: !FindInMap [RegionMap, !Ref "AWS::Region", TransitGatewayId]

  RoutePublicTGW3:
    Type: AWS::EC2::Route
    Condition: CreateTGWAttachement
    DependsOn: AttachmentToTransitGateway
    Properties:
      RouteTableId: !Ref RouteTablePublic
      DestinationCidrBlock: 172.16.0.0/12
      TransitGatewayId: !FindInMap [RegionMap, !Ref "AWS::Region", TransitGatewayId]

  RoutePublicTGW4:
    Type: AWS::EC2::Route
    Condition: CreateTGWAttachement
    DependsOn: AttachmentToTransitGateway
    Properties:
      RouteTableId: !Ref RouteTablePublic
      DestinationCidrBlock: 192.168.0.0/16
      TransitGatewayId: !FindInMap [RegionMap, !Ref "AWS::Region", TransitGatewayId]

  # VpnRoutePublicSubnet2:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePublic
  #     DestinationCidrBlock: 10.30.0.0/16
  #     GatewayId: !Ref VpnGateway

  # VpnRoutePublicSubnet3:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePublic
  #     DestinationCidrBlock: 10.24.0.0/16
  #     GatewayId: !Ref VpnGateway         

  # VpnRoutePublic4:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePublic
  #     DestinationCidrBlock: 10.0.240.0/23
  #     GatewayId: !Ref VpnGateway

  # VpnRoutePublic5:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePublic
  #     DestinationCidrBlock: 10.0.249.0/24
  #     GatewayId: !Ref VpnGateway

  # VpnRoutePublic6:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePublic
  #     DestinationCidrBlock: 10.0.250.0/24
  #     GatewayId: !Ref VpnGateway

  # VpnRoutePublic7:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePublic
  #     DestinationCidrBlock: 10.100.4.0/22
  #     GatewayId: !Ref VpnGateway

  DmzRoutePublic:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref RouteTablePublic
      DestinationCidrBlock: 145.234.240.0/22
      GatewayId: !Ref InternetGateway

# Add routes for private subnets

  RoutePrivateTGW1:
    Type: AWS::EC2::Route
    Condition: CreateTGWAttachement
    DependsOn: AttachmentToTransitGateway
    Properties:
      RouteTableId: !Ref RouteTablePrivate
      DestinationCidrBlock: 145.234.0.0/16
      TransitGatewayId: !FindInMap [RegionMap, !Ref "AWS::Region", TransitGatewayId]

  RoutePrivateTGW2:
    Type: AWS::EC2::Route
    Condition: CreateTGWAttachement
    DependsOn: AttachmentToTransitGateway
    Properties:
      RouteTableId: !Ref RouteTablePrivate
      DestinationCidrBlock: 10.0.0.0/8
      TransitGatewayId: !FindInMap [RegionMap, !Ref "AWS::Region", TransitGatewayId]

  RoutePrivateTGW3:
    Type: AWS::EC2::Route
    Condition: CreateTGWAttachement
    DependsOn: AttachmentToTransitGateway
    Properties:
      RouteTableId: !Ref RouteTablePrivate
      DestinationCidrBlock: 172.16.0.0/12
      TransitGatewayId: !FindInMap [RegionMap, !Ref "AWS::Region", TransitGatewayId]

  RoutePrivateTGW4:
    Type: AWS::EC2::Route
    Condition: CreateTGWAttachement
    DependsOn: AttachmentToTransitGateway
    Properties:
      RouteTableId: !Ref RouteTablePrivate
      DestinationCidrBlock: 192.168.0.0/16
      TransitGatewayId: !FindInMap [RegionMap, !Ref "AWS::Region", TransitGatewayId]
      
  # PeeringRoutePrivate:
  #   Type: AWS::EC2::Route
  #   Condition: CreateVpcPeering
  #   Properties:
  #     RouteTableId: !Ref RouteTablePrivate
  #     DestinationCidrBlock: !Ref PeerVpcCidr
  #     VpcPeeringConnectionId: !Ref VpcPeering 

  # PeeringRoutePrivatePeerVpc:
  #   Type: AWS::EC2::Route
  #   Condition: CreateVpcPeering
  #   Properties:
  #     RouteTableId: !Ref PeerVpcPrivateRouteTable
  #     DestinationCidrBlock:
  #       !GetAtt VpcIpAddressesCustomResource.outputVpcCidrBlock
  #     VpcPeeringConnectionId: !Ref VpcPeering      

  # VpnRoutePrivate:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePrivate
  #     DestinationCidrBlock: 145.234.0.0/16
  #     GatewayId: !Ref VpnGateway

  # VpnRoutePrivateSubnet2:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePrivate
  #     DestinationCidrBlock: 10.30.0.0/16
  #     GatewayId: !Ref VpnGateway      

  # VpnRoutePrivateSubnet3:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePrivate
  #     DestinationCidrBlock: 10.24.0.0/16
  #     GatewayId: !Ref VpnGateway         

  # VpnRoutePrivate4:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePrivate
  #     DestinationCidrBlock: 10.0.240.0/23
  #     GatewayId: !Ref VpnGateway

  # VpnRoutePrivate5:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePrivate
  #     DestinationCidrBlock: 10.0.249.0/24
  #     GatewayId: !Ref VpnGateway

  # VpnRoutePrivate6:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePrivate
  #     DestinationCidrBlock: 10.0.250.0/24
  #     GatewayId: !Ref VpnGateway

  # VpnRoutePrivate7:
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePrivate
  #     DestinationCidrBlock: 10.100.4.0/22
  #     GatewayId: !Ref VpnGateway

  # DmzRoutePrivateSubnet1: # Exception for RAS-TAM DMZ to be routed via VPN
  #   Type: AWS::EC2::Route
  #   DependsOn: AttachVpnGateway
  #   Condition: CreateVpn
  #   Properties:
  #     RouteTableId: !Ref RouteTablePrivate
  #     DestinationCidrBlock: 145.234.241.0/27
  #     GatewayId: !Ref VpnGateway

  DmzRoutePrivate:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RouteTablePrivate
      DestinationCidrBlock: 145.234.240.0/22
      NatGatewayId: !Ref NatGateway

  InternetRouteIntraVpc:
    Type: AWS::EC2::Route
    Condition: CreateIntraVpc
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref RouteTableIntraVpc
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  NatRoutePrivate:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RouteTablePrivate
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

# Associate the Public route table to the the first public subnet

  SubnetRouteTableAssociationPublicSubnet1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref RouteTablePublic

# Associate the Public route table to the the second public subnet

  SubnetRouteTableAssociationPublicSubnet2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref RouteTablePublic

# Associate the Public route table to the the third public subnet

  SubnetRouteTableAssociationPublicSubnet3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet3
      RouteTableId: !Ref RouteTablePublic

# Associate the primary Private route table to the the first private subnet

  SubnetRouteTableAssociationPrivateSubnet1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref RouteTablePrivate

# Associate the Secondary Private route table to the the second private subnet

  SubnetRouteTableAssociationPrivateSubnet2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref RouteTablePrivate

# Associate the Secondary Private route table to the the third private subnet

  SubnetRouteTableAssociationPrivateSubnet3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet3
      RouteTableId: !Ref RouteTablePrivate

# Associate the primary IntraVpc route table to the the first private subnet

  SubnetRouteTableAssociationIntraVpcSubnet1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateIntraVpc
    Properties:
      SubnetId: !Ref IntraVpcSubnet1
      RouteTableId: !Ref RouteTableIntraVpc

# Associate the Secondary IntraVpc route table to the the second private subnet

  SubnetRouteTableAssociationIntraVpcSubnet2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateIntraVpc
    Properties:
      SubnetId: !Ref IntraVpcSubnet2
      RouteTableId: !Ref RouteTableIntraVpc

# Associate the Secondary IntraVpc route table to the the third private subnet

  SubnetRouteTableAssociationIntraVpcSubnet3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateIntraVpc
    Properties:
      SubnetId: !Ref IntraVpcSubnet3
      RouteTableId: !Ref RouteTableIntraVpc

# Associate mediait.ch DNS reslover rule if needed

  AssociateMediaItResolverRule:
    Condition: AssociateMediaItDnsResolver
    Type: AWS::Route53Resolver::ResolverRuleAssociation
    Properties: 
      Name: MediaItDnsRuleAssociation
      ResolverRuleId: !FindInMap [RegionMap, !Ref "AWS::Region", MediaItResolverRuleId]
      VPCId: !Ref Vpc

Outputs:

  Vpc:
    Value: !Ref Vpc
    Export:
      Name: Vpc
      
  VpcCidrBlock:
    Value:
        !GetAtt VpcIpAddressesCustomResource.outputVpcCidrBlock
    Export:
      Name: Vpc-CidrBlock

  Az1:
    Value: !FindInMap [RegionMap, !Ref "AWS::Region", Az1]
    Export:
      Name: Az1

  Az2:
    Value: !FindInMap [RegionMap, !Ref "AWS::Region", Az2]
    Export:
      Name: Az2

  Az3:
    Value: !FindInMap [RegionMap, !Ref "AWS::Region", Az3]
    Export:
      Name: Az3

  PublicSubnet1:
    Value: !Ref PublicSubnet1
    Export:
      Name: PublicSubnet1
      
  PublicSubnet1CidrBlock:
    Value:
        !GetAtt VpcIpAddressesCustomResource.outputAz1Public
    Export:
      Name: PublicSubnet1-CidrBlock

  PublicSubnet2:
    Value: !Ref PublicSubnet2
    Export:
      Name: PublicSubnet2
      
  PublicSubnet2CidrBlock:
    Value:
        !GetAtt VpcIpAddressesCustomResource.outputAz2Public
    Export:
      Name: PublicSubnet2-CidrBlock

  PublicSubnet3:
    Value: !Ref PublicSubnet3
    Export:
      Name: PublicSubnet3
      
  PublicSubnet3CidrBlock:
    Value:
        !GetAtt VpcIpAddressesCustomResource.outputAz3Public
    Export:
      Name: PublicSubnet3-CidrBlock

  PrivateSubnet1:
    Value: !Ref PrivateSubnet1
    Export:
      Name: PrivateSubnet1
      
  PrivateSubnet1CidrBlock:
    Value:
        !GetAtt VpcIpAddressesCustomResource.outputAz1Private
    Export:
      Name: PrivateSubnet1-CidrBlock

  PrivateSubnet2:
    Value: !Ref PrivateSubnet2
    Export:
      Name: PrivateSubnet2
      
  PrivateSubnet2CidrBlock:
    Value:
        !GetAtt VpcIpAddressesCustomResource.outputAz2Private
    Export:
      Name: PrivateSubnet2-CidrBlock
      
  PrivateSubnet3:
    Value: !Ref PrivateSubnet3
    Export:
      Name: PrivateSubnet3
      
  PrivateSubnet3CidrBlock:
    Value:
        !GetAtt VpcIpAddressesCustomResource.outputAz3Private
    Export:
      Name: PrivateSubnet3-CidrBlock

  IntraVpcSubnet1:
    Condition: CreateIntraVpc
    Value: !Ref IntraVpcSubnet1
    Export:
      Name: IntraVpcSubnet1
      
  IntraVpcSubnet1CidrBlock:
    Condition: CreateIntraVpc
    Value:
        !GetAtt VpcIpAddressesCustomResource.outputAz1IntraVpc
    Export:
      Name: IntraVpcSubnet1-CidrBlock

  IntraVpcSubnet2:
    Condition: CreateIntraVpc
    Value: !Ref IntraVpcSubnet2
    Export:
      Name: IntraVpcSubnet2
      
  IntraVpcSubnet2CidrBlock:
    Condition: CreateIntraVpc
    Value:
        !GetAtt VpcIpAddressesCustomResource.outputAz2IntraVpc
    Export:
      Name: IntraVpcSubnet2-CidrBlock
      
  IntraVpcSubnet3:
    Condition: CreateIntraVpc
    Value: !Ref IntraVpcSubnet3
    Export:
      Name: IntraVpcSubnet3
      
  IntraVpcSubnet3CidrBlock:
    Condition: CreateIntraVpc
    Value:
        !GetAtt VpcIpAddressesCustomResource.outputAz3IntraVpc
    Export:
      Name: IntraVpcSubnet3-CidrBlock

  NatGatewayEip:
    Value: !Ref NatGatewayEip
    Export:
      Name: NatGatewayEip
